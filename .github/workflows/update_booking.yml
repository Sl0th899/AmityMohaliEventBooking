name: Process New Booking

on:
  repository_dispatch:
    types: [new_booking]

# CRITICAL: Serialize runs. If 50 people book, they queue up 1-by-1.
# This prevents race conditions entirely.
concurrency: 
  group: booking-queue
  cancel-in-progress: false

jobs:
  process-booking:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main 

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Transactional Update
        id: update
        env:
          PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          node -e '
            const fs = require("fs");
            const payload = JSON.parse(process.env.PAYLOAD);
            const DB_FILE = "bookings.json";

            // 1. Sanitize Inputs (XSS Prevention)
            const cleanText = (txt) => txt.replace(/[<>]/g, ""); 
            payload.event = cleanText(payload.event);
            payload.club = cleanText(payload.club);

            // 2. Load DB
            let bookings = [];
            if (fs.existsSync(DB_FILE)) {
               try { bookings = JSON.parse(fs.readFileSync(DB_FILE, "utf8")); }
               catch(e) { bookings = []; }
            }

            // 3. Idempotency Check (Check by Transaction ID)
            const exists = bookings.some(b => b.transaction_id === payload.transaction_id);
            if (exists) {
              console.log("Idempotent skip: Booking already exists.");
              process.exit(0);
            }

            // 4. Conflict Validation (The "Critical Section")
            const isConflict = bookings.some(b => 
              b.date === payload.date && 
              b.slot === payload.slot && 
              b.location_id === payload.location_id
            );

            if (isConflict) {
              console.error("::error::CONFLICT: Slot taken.");
              process.exit(1); 
            }

            // 5. Commit to Disk
            bookings.push(payload);
            fs.writeFileSync(DB_FILE, JSON.stringify(bookings, null, 2));
          '

      - name: Commit & Push
        if: success()
        run: |
          git config --global user.name "Booking Bot"
          git config --global user.email "bot@amity.edu"
          git add bookings.json
          # If file hasnt changed (idempotency skip), commit will fail empty. That is fine.
          git commit -m "Booking: ${{ github.event.client_payload.transaction_id }}" || echo "Nothing to commit"
          git push