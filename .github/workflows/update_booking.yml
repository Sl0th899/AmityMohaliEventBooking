name: Process New Booking

on:
  repository_dispatch:
    types: [new_booking]

jobs:
  update-db:
    runs-on: ubuntu-latest
    
    # Permission needed to push changes
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Process Booking and Update JSON
        id: process
        env:
          PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          node -e '
            const fs = require("fs");
            
            // 1. Load incoming payload
            const payload = JSON.parse(process.env.PAYLOAD);
            console.log("Processing request:", payload);

            // 2. Load existing DB
            const dbFile = "bookings.json";
            let bookings = [];
            
            try {
              if (fs.existsSync(dbFile)) {
                const data = fs.readFileSync(dbFile, "utf8");
                bookings = JSON.parse(data);
              }
            } catch (err) {
              console.error("Error reading DB, starting fresh.", err);
            }

            // 3. Validation: Check for duplicates
            const isConflict = bookings.some(b => 
              b.date === payload.date && 
              b.slot === payload.slot && 
              b.location_id === payload.location_id
            );

            if (isConflict) {
              console.error("CONFLICT: Slot already booked.");
              process.exit(1); // Fail the workflow
            }

            // 4. Append new booking
            bookings.push(payload);
            
            // 5. Write back to disk
            fs.writeFileSync(dbFile, JSON.stringify(bookings, null, 2));
            console.log("Booking appended successfully.");
          '

      - name: Commit and Push Changes
        if: success()
        run: |
          git config --global user.name "Booking Bot"
          git config --global user.email "bot@amity.edu"
          
          git add bookings.json
          git commit -m "New Booking: ${{ github.event.client_payload.club }} @ ${{ github.event.client_payload.date }}"
          
          # Retry loop for concurrency safety (pull --rebase on failure)
          n=0
          until [ "$n" -ge 5 ]
          do
             git pull --rebase && git push && break
             n=$((n+1)) 
             echo "Push failed, retrying ($n/5)..."
             sleep 5
          done
          
          if [ "$n" -eq 5 ]; then
             echo "Failed to push after 5 retries"
             exit 1
          fi